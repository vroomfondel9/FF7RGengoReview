<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.23.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div id="game-container"></div>

<script src="assets/text/content.js" type="text/javascript"></script>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
	parent: 'game-container',
    width: 800,
    height: 600,
	dom: {
        createContainer: true
    },
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var lang = content.JAPANESE;

var player;

var enemy;

var ui;

var ground;
var foreground;
var cursors;
var controls;
var gameOver = false;

var game = new Phaser.Game(config);

function preload ()
{
	// Background
    this.load.image('background', 'assets/images/backgrounds/background1.png');
    this.load.image('groundfore', 'assets/images/backgrounds/ground/groundfore-1.png');
	this.load.image('groundback', 'assets/images/backgrounds/ground/groundback-1.png');
	
	// Player
    this.load.spritesheet('player-idle', 'assets/images/sprites/player/player-idle.png', { frameWidth: 96, frameHeight: 97});
	this.load.spritesheet('player-run', 'assets/images/sprites/player/player-run.png', { frameWidth: 79, frameHeight: 97});
	this.load.spritesheet('player-attack', 'assets/images/sprites/player/player-attack.png', { frameWidth: 96, frameHeight: 96});
	this.load.spritesheet('player-land', 'assets/images/sprites/player/player-land3.png', { frameWidth: 96, frameHeight: 104});
	
	// UI
	this.load.image('ui-bottom-foreground', 'assets/images/ui/menu-bottom-foreground6.png');
	this.load.image('ui-bottom-background', 'assets/images/ui/menu-bottom-background1.png');
	this.load.image('ui-bottom-gauge-single-green', 'assets/images/ui/single-gauge-green.png');
	this.load.image('ui-bottom-gauge-single-pink', 'assets/images/ui/single-gauge-pink2.png');
	this.load.image('ui-command-menu', 'assets/images/ui/command-menu4.png');
	this.load.image('ui-command-sub-menu', 'assets/images/ui/command-sub-menu3.png');
	this.load.image('ui-move-name', 'assets/images/ui/move-name-label3.png');
	this.load.image('ui-cursor', 'assets/images/ui/cursor.png');
	this.load.html('ui-answerform', 'assets/text/answerform.html');
}

function create ()
{
	createEnvironment(this);
	createPlayer(this);
	createEnemies(this);
	createUI(this);
	createControls(this);
}

function update (game)
{
    if (gameOver)
    {
        return;
    }
	
	
	if (ui.controlledobject != null) {
		if (Phaser.Input.Keyboard.JustDown(controls.UP))
		{
			ui.controlledobject.previous();
		}
		if (Phaser.Input.Keyboard.JustDown(controls.DOWN))
		{
			ui.controlledobject.previous();
		}
		if (Phaser.Input.Keyboard.JustDown(controls.ENTER))
		{
			ui.controlledobject.confirm();
		}
		if (Phaser.Input.Keyboard.JustDown(controls.ESCAPE))
		{
			ui.controlledobject.cancel();
		}
	}
	
	// TODO only for test purposes
	if (Phaser.Input.Keyboard.JustDown(controls.RIGHT))
	{
		ui.status.time.pause();
	}
	
	if (Phaser.Input.Keyboard.JustDown(controls.LEFT))
	{
		ui.status.time.resume();
	}
}

function createEnvironment(game) {
	// Cosmetic background
    game.add.image(400, 200, 'background');
	
	// Grouping of physics bodies
    ground = game.physics.add.staticGroup();

	game.add.image(400, 329, 'groundback').setScale(2);
    foreground = ground.create(400, 394, 'groundfore').setScale(2).refreshBody();
}

function createUI(game) {
	// Create UI parent container
	ui = {};
	
	createUIStatusDisplay(game);
	createUIMoveName(game);
	
	createAnswerSubCommandMenu(game);
	
	createCommandMenu(game);
	
	ui.controlledobject = ui.command;
}

function createUIMoveName(game) {
	ui.movename = {};

	// Move Name Label
	ui.movename.background = game.add.image(400, 50, 'ui-move-name');
	ui.movename.background.setDepth(200);
	ui.movename.background.visible = false;
	
	ui.movename.label = game.add.text(400, 50, "", {fontSize: '24px', fill: '#FFF'});
	ui.movename.label.setStroke('#BBB', 2);
	ui.movename.label.setOrigin(0.5);
	ui.movename.label.setDepth(210);
	ui.movename.label.visible = false;
	
	// Behaviors
	ui.movename.show = function(movename) {
		ui.movename.label.setText(movename);
		ui.movename.label.visible = true;
		ui.movename.background.visible = true;
	}
	
	ui.movename.hide = function() {
		ui.movename.label.visible = false;
		ui.movename.background.visible = false;
	}
}

function createUIStatusDisplay(game) {
	ui.status = {};

	ui.status.background = game.add.image(400, 520, 'ui-bottom-background');
	ui.status.background.setDepth(10);
	
	ui.status.limit = game.add.image(601, 474, 'ui-bottom-gauge-single-pink');
	ui.status.limit.setDepth(14);
	ui.status.limit.setOrigin(0);
	//TODO base on # of enemies
	ui.status.limit.incrementAmount = 0.1;
	ui.status.limit.setScale(0, 1);
	
	ui.status.time = game.add.image(700, 474, 'ui-bottom-gauge-single-green');
	ui.status.time.setDepth(14);
	ui.status.time.setOrigin(0);
	ui.status.time.fillTime = 1000;
	ui.status.time.elapsed = 0;
	ui.status.time.setScale(0, 1);
	
	ui.status.foreground = game.add.image(400, 520, 'ui-bottom-foreground');
	ui.status.foreground.setDepth(20);
	
	ui.status.playername = game.add.text(15, 475, content["status-player-name"][lang], {fontSize: '24px', fill: '#FFF'});
	ui.status.playername.setStroke('#BBB', 2);
	ui.status.playername.setOrigin(0);
	ui.status.playername.setDepth(22);
	
	createUIStatusDisplayBehavior(game);
}

function createUIStatusDisplayBehavior(game) {
	ui.status.time.resume = function() {
		ui.status.time.tween = game.tweens.timeline({
			tweens: [
				{
					targets     : [ ui.status.time ],
					scaleX: 1,
					ease        : 'Linear',
					duration    : ui.status.time.fillTime - ui.status.time.elapsed,
					yoyo        : false,
					repeat      : 0,
					callbackScope   : ui.status.time,
					onComplete: function() {
						console.log('called time');
						ui.status.time.setScale(0, 1);
						ui.status.time.elapsed = 0;
					}
				},
			]
		});
	};
	
	ui.status.time.pause = function() {
		if (ui.status.time.tween != null) {
			ui.status.time.elapsed += ui.status.time.tween.elapsed;
			ui.status.time.tween.stop();
			console.log(ui.status.time.elapsed);
		}
	};
	
	ui.status.limit.enemydefeated = function() {
		game.tweens.timeline({
			tweens: [
				{
					targets     : [ ui.status.limit ],
					scaleX: '+' + ui.status.limit.incrementAmount,
					ease        : 'Linear',
					duration    : 300,
					yoyo        : false,
					repeat      : 0,
					callbackScope   : ui.status.limit,
					onComplete: function() {
						//floating point precision means cannot compare to 1.0
						if (ui.status.limit.scaleX >= 0.999) {
							console.log('TODO limit gauge full PLACEHOLDER');
						}
					}
				},
			]
		});
	}
}

function createCommandMenu(game) {
	ui.command = {};
	
	const optionsRaw = [
		content["command-options-answer"][lang], 
		//content["command-options-magic"][lang], 
		content["command-options-sense"][lang],  
		//content["command-options-item"][lang], 
	];
	
	ui.command.numOptions = optionsRaw.length;
	ui.command.current = 0;
	ui.command.selected = false;

	ui.command.background = game.add.image(275, 520, 'ui-command-menu');
	ui.command.background .setDepth(50);
	
	// Menu Options Text
	const commandFontSize = 24;
	ui.command.options = [];
	for (var i = 0; i < ui.command.numOptions; i++) {
		ui.command.options[i] = {};
		
		ui.command.options[i].text = game.add.text(230, 458 + (commandFontSize + 10) * i, optionsRaw[i], {fontSize: commandFontSize + 'px', fill: '#FFF'});
		ui.command.options[i].text.setStroke('#BBB', 2);
		ui.command.options[i].text.setOrigin(0);
		ui.command.options[i].text.setDepth(52);
		
		ui.command.options[i].hasSubMenu = optionsRaw[i] != content["command-options-sense"][lang];
		ui.command.options[i].freeEntrySubmenu = optionsRaw[i] == content["command-options-answer"][lang];
		ui.command.options[i].alliesSelectableDefault = false;
		ui.command.options[i].enemiesSelectableDefault = true;
		
		ui.command.sub = createCommandBehaviors(game, ui.command.options[i], optionsRaw[i]);
	}
	
	createCommandCursor(game, commandFontSize);
	
	// Standard Behaviors
	ui.command.confirm = function () {ui.command.cursor.anim_select();};
	ui.command.cancel = function () {ui.command.cursor.anim_deselect();};
	ui.command.next = function () {ui.command.cursor.next();};
	ui.command.previous = function () {ui.command.cursor.prev();};
}

function createCommandCursor(game, commandFontSize) {
	// Command Cursor
	const cursorYOffset = commandFontSize / 2 - 3;
	ui.command.cursor = game.add.image(ui.command.options[ui.command.current].text.x, ui.command.options[ui.command.current].text.y + cursorYOffset, 'ui-cursor');
	ui.command.cursor.setScale(0.10);
	ui.command.cursor.setOrigin(1, 0.5);
	ui.command.cursor.setDepth(54);
	ui.command.cursor.selected = false;
	
	// Cursor Animations & Behaviors
	ui.command.cursor.anim_select = function() {
		ui.command.cursor.selected = true;
		if (ui.command.cursor.tween_select) {
			ui.command.cursor.tween_select.stop();
		}
		ui.command.cursor.tween_select = game.tweens.timeline({
			tweens: [
				{
					targets: ui.command.cursor,
					alpha: "-=1",
					duration: 0.5
				},
				{
					targets: ui.command.cursor,
					alpha: "+=1",
					duration: 0.5
				},
			],
			loop: -1
		});
		ui.command.options[ui.command.current].selectCallback();
	};
	
	ui.command.cursor.anim_deselect = function() {
		ui.command.cursor.selected = false;
		if (ui.command.cursor.tween_select) {
			ui.command.cursor.tween_select.stop();
		}
		ui.command.cursor.alpha = 1;
	};
	
	ui.command.cursor.advance = function(index) {
		ui.command.current = (index >= ui.command.numOptions) ? 0 : ((index < 0) ? ui.command.numOptions - 1 : index);
		ui.command.cursor.x = ui.command.options[ui.command.current].text.x;
		ui.command.cursor.y = ui.command.options[ui.command.current].text.y + cursorYOffset;
	};
	
	ui.command.cursor.next = function() {ui.command.cursor.advance(ui.command.current + 1);};
	ui.command.cursor.prev = function() {ui.command.cursor.advance(ui.command.current - 1);};
}

function createCommandBehaviors(game, curOption, parentMenuName) {
	if (content["command-options-answer"][lang] == parentMenuName) {
		curOption.selectCallback = function() {ui.sub.answer.show();};
	}
	else if (content["command-options-sense"][lang] == parentMenuName) {
		curOption.selectCallback = function() {console.log('TODO Sense Functionality Placeholder'); ui.command.cursor.anim_deselect();};
	}
}

function createAnswerSubCommandMenu(game) {
	if (!ui.sub) {
		ui.sub = {};
	}
	ui.sub.answer = {};

	// Sub Menu Background
	ui.sub.answer.background = game.add.image(175, 530, 'ui-command-sub-menu');
	ui.sub.answer.background.setDepth(70);
	ui.sub.answer.background.setVisible(false);
	
	// Input Label
	const labelFontSize = 24;
	const labelY = 530 - (ui.sub.answer.background.height / 2) + (labelFontSize + 0);
	ui.sub.answer.label = game.add.text(175, labelY, content["sub-answer-recall-label"][lang], {fontSize: labelFontSize + 'px', fill: '#FFF'});
	ui.sub.answer.label.setStroke('#BBB', 2);
	ui.sub.answer.label.setOrigin(0.5);
	ui.sub.answer.label.setDepth(72);
	ui.sub.answer.label.setVisible(false);
	
	// Input Box
	ui.sub.answer.htmlcontainer = game.add.dom(175, labelY + labelFontSize + 30).createFromCache('ui-answerform');
	ui.sub.answer.htmlcontainer.setDepth(72);
	ui.sub.answer.htmlcontainer.setVisible(false);
	ui.sub.answer.input = ui.sub.answer.htmlcontainer.getChildByName('answerField');

	createAnswerSubMenuBehaviors(game);
}

function createAnswerSubMenuBehaviors(game) {
	// Custom Behaviors
	ui.sub.answer.showOrHide = function(show) {
		ui.sub.answer.background.setVisible(show);
		ui.sub.answer.label.setVisible(show);
		ui.sub.answer.htmlcontainer.setVisible(show);
		
		var value = ui.sub.answer.input.value;
		ui.sub.answer.input.value = '';
		
		if (!show) {
			ui.command.cursor.anim_deselect();
			window.setTimeout(function ()
			{
				ui.sub.answer.input.blur();
			}, 0);
			ui.controlledobject = ui.command;
		}
		else {
			window.setTimeout(function ()
			{
				ui.sub.answer.input.focus();
			}, 0);
			ui.controlledobject = ui.sub.answer;
		}
		
		return value;
	};
	ui.sub.answer.show = function() {ui.sub.answer.showOrHide(true);};
	
	// Standard Behaviors
	ui.sub.answer.confirm = function() {
		// TODO placeholder
		acceptableAnswers = ["うかつ"];
		
		var providedAnswer = ui.sub.answer.showOrHide(false);
		
		player.anim_attack(providedAnswer, acceptableAnswers);
	};
	ui.sub.answer.cancel = function() {ui.sub.answer.showOrHide(false);};
	ui.sub.answer.next = function () {};
	ui.sub.answer.previous = function () {};
}

function createPlayer(game) {
	var surfaceHeight = foreground.getBounds().y - (foreground.getBounds().height / 2)

	player = game.physics.add.sprite(600, surfaceHeight, 'player-idle');
	player.setScale(3);
	player.setDepth(100);
	player.flipX = true;
	player.setY(surfaceHeight - (player.height / 2) - 50);
	player.animating = false;

    //  Animations
    createPlayerAnimations(game);
	
	//  Physics
	player.setBounce(0.5);
	player.setDrag(1000, 0);
	player.body.setAllowDrag(false);
	game.physics.add.collider(player, ground);
	
	player.anims.play('player-idle', true);
}

function createPlayerAnimations(game) {
	// Tweens Definitions
	game.anims.create({
        key: 'player-idle',
        frames: game.anims.generateFrameNumbers('player-idle', { start: 0, end: 6 }),
        frameRate: 10,
        repeat: -1
    });
	game.anims.create({
        key: 'player-run',
        frames: game.anims.generateFrameNumbers('player-run', { start: 0, end: 9 }),
        frameRate: 10,
        repeat: -1
    });
	game.anims.create({
        key: 'player-attack',
        frames: game.anims.generateFrameNumbers('player-attack', { start: 0, end: 5 }),
        frameRate: 10
    });
	game.anims.create({
        key: 'player-land',
        frames: game.anims.generateFrameNumbers('player-land', { start: 0, end: 2 }),
        frameRate: 10
    });
	
	// Full Animations
	player.anim_attack = function(playerAnswer, acceptableAnswers) {
		if (!player.animating)
		{
			player.animating = true;
			ui.movename.show(playerAnswer);
			
			game.tweens.timeline({
				tweens: [
					{
						targets: player,
						alpha: "+=0",
						duration: 1,
						onComplete: function() {
							player.setVelocityX(-420);
							player.anims.play('player-run', true);
						}
					},
					{
						targets: player,
						alpha: "+=0",
						duration: 1000,
						onComplete: function() {
							player.setVelocityX(360);
							player.setVelocityY(-160);
							
							if (acceptableAnswers.indexOf(playerAnswer) != -1)
							{
								enemy.anim_get_hit_and_die();
							}
							else
							{
								enemy.anim_dodge();
							}
							
							player.anims.play('player-attack', true);
						}
					},
					{
						targets: player,
						alpha: "+=0",
						duration: 1000,
						onComplete: function() {
							player.body.setAllowDrag(true);
							player.anims.play('player-land', true);
						}
					},
					{
						targets: player,
						alpha: "+=0",
						duration: 400,
						onComplete: function() {
							ui.movename.hide();
							player.body.setAllowDrag(false);
							player.anims.play('player-idle', true);
							player.animating = false;
						}
					}
				]

			});
		}
	};
}

function createEnemies(game) {
	const fontSize = 32;
	const strokeSize = 8;
	const fontColor = '#FFF';
	const strokeBaseColor = '#1f039c';
	const wrapWidth = 500;
	const lineHeight = fontSize + strokeSize;

	text = 'うかつ！足が挟まって';

	enemy = game.add.text(300, 275, text, {fontSize: fontSize + 'px', fill: fontColor,  wordWrap: {width: wrapWidth, useAdvancedWrap: true}});
	enemy.setStroke(strokeBaseColor, strokeSize);
	numLines = enemy.getWrappedText(text).length;
	enemy.setOrigin(0.5);
	enemy.animating = false;
	
	var floatHeight = foreground.getBounds().y - (foreground.getBounds().height / 2) - 25;
	var textbottom = enemy.getBounds().y + (numLines - 1) * lineHeight;
	enemy.setY(enemy.getBounds().y  - (textbottom - floatHeight));
	
	// Animations
	createEnemyAnimations(game, fontColor, strokeBaseColor, strokeSize);
}

function createEnemyAnimations(game, fontColor, strokeBaseColor, strokeSize) {
	// Animation-Specific Colors
	const fontColorKilled = '#ff0008';
	const strokeHitColor = '#990207';
	const col_font_alive = Phaser.Display.Color.HexStringToColor(fontColor);
	const col_font_killed = Phaser.Display.Color.HexStringToColor(fontColorKilled);
	const col_stroke_alive = Phaser.Display.Color.HexStringToColor(strokeBaseColor);
	const col_stroke_killed = Phaser.Display.Color.HexStringToColor(strokeHitColor);

	// Full Animations
	enemy.anim_dodge = function() {
		if (!enemy.animating)
		{
			enemy.animating = true;
			var tiltX = 50 + 50 * Math.random();
			var tiltY = 50 + 50 * Math.random();
			
			game.tweens.timeline({
				tweens: [
					{
						targets: enemy,
						x: '-=' + tiltX,
						y: '-=' + tiltY,
						angle: -10 - 15 * Math.random(),
						duration: 800,
						ease: 'Elastic',
						easeParams: [ 1.5, 0.5 ]
					},
					{
						targets: enemy,
						x: '+=' + tiltX,
						y: '+=' + tiltY,
						angle: 0,
						duration: 800,
						delay: 1000,
						ease: 'Elastic',
						easeParams: [ 1.5, 0.5 ],
						onComplete: function() {enemy.animating = false;}
					}
				]
			});
		}
	};
	
	enemy.anim_get_hit_and_die = function() {
		if (!enemy.animating)
		{
			const killDuration = 1000;
		
			enemy.animating = true;
			var tiltX = 35 + 35 * Math.random();
			var tiltY = 15 + 15 * Math.random();
			
			game.tweens.timeline({
				tweens: [
					{
						targets: enemy,
						x: '-=' + tiltX,
						y: '+=' + tiltY,
						angle: 3 + 5 * Math.random(),
						duration: 800,
						delay: 200,
						ease: 'Elastic',
						easeParams: [ 1.5, 0.5 ]
					},
					{
						targets: enemy,
						alpha: 0,
						onUpdate: function(state) {
							var totalDuration = state.duration + 800 + 200;
							var curFillColor = Phaser.Display.Color.Interpolate.ColorWithColor(col_font_alive, col_font_killed, totalDuration, state.elapsed);
							var curStrokeColor = Phaser.Display.Color.Interpolate.ColorWithColor(col_stroke_alive, col_stroke_killed, totalDuration, state.elapsed);
							var curFillColorHex = Phaser.Display.Color.RGBToString(curFillColor.r, curFillColor.g, curFillColor.b, curFillColor.a).substring(0, 7);
							var curStrokeColorHex = Phaser.Display.Color.RGBToString(curStrokeColor.r, curStrokeColor.g, curStrokeColor.b, curStrokeColor.a).substring(0, 7);
							
							enemy.setColor(curFillColorHex);
							enemy.setStroke(curStrokeColorHex, strokeSize);
						},
						duration: killDuration,
						delay: 200,
						ease: 'Linear'
					},
					{
						targets: enemy,
						x: '+=' + tiltX - 800,
						y: '-=' + tiltY,
						angle: 0,
						alpha: 1,
						duration: 1,
						delay: 800,
						ease: 'Linear',
						onComplete: function() {enemy.setColor(fontColor); enemy.setStroke(strokeBaseColor, strokeSize); enemy.animating = false;}
					}
				]
			});
		}
	};
}

function createControls(game) {
	controls = {};
	
	// Keys to listen to
	controls.UP = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
	controls.DOWN = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
	controls.LEFT = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
	controls.RIGHT = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
	
	controls.ENTER = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);
	controls.ESCAPE = game.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC);
}

</script>

</body>
</html>